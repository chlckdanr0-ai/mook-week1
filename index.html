<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flower Drying Guide</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
    </script>
</head>
<body>

    <button id="theme-toggle" class="theme-toggle">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>

    <div class="card">
        <h1>ğŸŒ¸ ê½ƒ ê±´ì¡° ê°€ì´ë“œ</h1>

        <label class="upload-btn">
            ì‚¬ì§„ ì„ íƒ
            <input type="file" accept="image/*" onchange="loadImage(event)">
        </label>

        <img id="preview">
        <div id="result"></div>
    </div>

    <script src="main.js"></script>
    <script>
        const MODEL_URL = "YOUR_MODEL_URL/"; 
        let model;

        async function init() {
            if (!model) {
                model = await tmImage.load(
                    MODEL_URL + "model.json",
                    MODEL_URL + "metadata.json"
                );
            }
        }

        async function loadImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function() {
                const img = document.getElementById("preview");
                img.src = reader.result;
                img.style.display = "block";

                await init();

                const prediction = await model.predict(img);
                prediction.sort((a, b) => b.probability - a.probability);

                const flowerName = prediction[0].className;
                await checkDryingPeriod(flowerName);
            };
            reader.readAsDataURL(file);
        }

        async function checkDryingPeriod(name) {
            const flowerRef = window.doc(window.db, "flowers", name);
            const flowerSnap = await window.getDoc(flowerRef);

            if (flowerSnap.exists() && flowerSnap.data().status === "approved") {
                document.getElementById("result").innerHTML = `
                    ğŸŒ¸ <b>${name}</b><br>
                    ğŸ•’ ê±´ì¡° ê¸°ê°„: ${flowerSnap.data().dryingPeriod}
                `;
            } else {
                await window.setDoc(flowerRef, {
                    dryingPeriod: null,
                    status: "pending",
                    createdAt: new Date()
                });

                document.getElementById("result").innerHTML = `
                    ğŸŒ¸ <b>${name}</b><br>
                    ğŸ•’ ê±´ì¡° ê¸°ê°„: ê´€ë¦¬ì í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.
                `;
            }
        }
    </script>
</body>
</html>
